(()=>{"use strict";var t={655:(t,e,i)=>{i.d(e,{Z:()=>o});var s=i(81),n=i.n(s),r=i(645),h=i.n(r)()(n());h.push([t.id,".cg-component-dialog-text-renderer {\n    align-items: center;\n    cursor: default;\n    display: flex;\n    font-size: 64px;\n    height: 516px;\n    overflow: hidden;\n    position: absolute;\n    transform-origin: left top;\n    user-select: none;\n    width: 1258px;\n}\n\n.cg-component-dialog-text-renderer p {\n    display: -webkit-box;\n    margin: 0;\n    overflow: hidden;\n    -webkit-box-orient: vertical;\n    -webkit-line-clamp: 6;\n}\n",""]);const o=h},303:(t,e,i)=>{i.d(e,{Z:()=>o});var s=i(81),n=i.n(s),r=i(645),h=i.n(r)()(n());h.push([t.id,"* {\n    margin: 0 0;\n    padding: 0 0;\n}\n\nhtml {\n    height: 100%;\n    width: 100%;\n}\n\nbody {\n    background-color: black;\n    height: 100%;\n    overflow: hidden;\n    width: 100%;\n}\n\n.cg-game {\n    align-items: center;\n    display: flex;\n    justify-content: center;\n    overflow: hidden;\n}\n\n/* Game custom alert modal window */\n.cg-game-alert {\n    align-items: center;\n    display: flex;\n    height: 100%;\n    justify-content: center;\n    position: absolute;\n    width: 100%;\n    z-index: 99;\n}\n\n.cg-game-alert-blur {\n    backdrop-filter: blur(3px);\n    background-color: rgba(37, 37, 37, 0.6);\n}\n\n.cg-game-alert-window {\n    height: 50%;\n    position: relative;\n    width: 50%;\n    z-index: 100;\n}\n\n.cg-game-alert-background {\n    height: 100%;\n    position: absolute;\n    width: 100%;\n}\n\n.cg-game-alert-text {\n    align-items: center;\n    cursor: default;\n    display: flex;\n    font-size: 3vh;\n    height: 60%;\n    justify-content: center;\n    left: 10%;\n    position: relative;\n    top: 10%;\n    user-select: none;\n    width: 80%;\n}\n\n.cg-game-alert-text b {\n    color: lightsalmon;\n}\n\n.cg-game-alert-confirm {\n    cursor: pointer;\n    display: block;\n    height: 10%;\n    margin: 10% auto;\n    position: relative;\n}\n\n.cg-game-alert-confirm:hover {\n    opacity: 0.8;\n}\n\n/* Menu */\n.menu-modal {\n    align-items: center;\n    backdrop-filter: blur(3px);\n    background-color: rgba(37, 37, 37, 0.8);\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    justify-content: center;\n    position: absolute;\n    width: 100%;\n    z-index: 99;\n}\n\n.menu-option {\n    align-items: center;\n    background: linear-gradient(70deg, rgb(200, 200, 200), rgb(100, 100, 100), rgb(150, 150, 150));\n    border: solid white 1px;\n    color: white;\n    cursor: default;\n    display: flex;\n    font-size: 2vh;\n    height: 8%;\n    justify-content: center;\n    margin-bottom: 3%;\n    user-select: none;\n    width: 20%;\n}\n\n.menu-option:hover {\n    background: linear-gradient(70deg, rgba(200, 200, 200, 0.8), rgba(100, 100, 100, 0.8), rgba(150, 150, 150, 0.8));\n}\n\n/* About */\n.about-modal {\n    align-items: center;\n    backdrop-filter: blur(3px);\n    background-color: rgba(37, 37, 37, 0.8);\n    display: flex;\n    height: 100%;\n    justify-content: center;\n    position: absolute;\n    width: 100%;\n    z-index: 99;\n}\n\n#about-content {\n    background-color: rgb(200, 200, 200);\n    box-sizing: border-box;\n    cursor: default;\n    height: 80%;\n    overflow-y: auto;\n    padding: 5vh 3vw;\n    width: 50%;\n}\n\n#about-content p {\n    font-size: 1.5vh;\n    margin-bottom: 1vh;\n}\n\n#about-content ul {\n    font-size: 1.5vh;\n    margin-bottom: 1vh;\n    margin-left: 2vh;\n}\n\n#about-content li {\n    margin-bottom: 1vh;\n}\n\n#about-content h1 {\n    font-size: 3vh;\n    line-height: 2;\n    text-align: center;\n}\n\n#about-content h2 {\n    border-bottom: solid gray 0.5px;\n    font-size: 2vh;\n    line-height: 1.5;\n    margin-bottom: 1vh;\n}\n\n#about-content a {\n    color: blue;\n    text-decoration: none;\n}\n\n#about-content a:visited {\n    color: blue;\n}\n\n#about-close {\n    align-items: center;\n    background-color: lightgray;\n    border: solid white 1px;\n    border-radius: 0.5vh;\n    cursor: default;\n    display: flex;\n    justify-content: center;\n    margin: auto;\n    margin-top: 2vh;\n    padding: 1vh 0;\n    user-select: none;\n    width: 10%;\n}\n\n#about-close:hover {\n    background-color: gray;\n}\n",""]);const o=h},734:(t,e,i)=>{i.d(e,{Z:()=>o});var s=i(81),n=i.n(s),r=i(645),h=i.n(r)()(n());h.push([t.id,"body {\n    height: 100vh;\n    width: 100vw;\n}\n\n.progress-wrapper {\n    background-color: black;\n    height: 100%;\n    position: absolute;\n    top: 0;\n    width: 100%;\n}\n\n.progress-text {\n    animation: blink 2s infinite ease-in-out;\n    box-sizing: border-box;\n    color: white;\n    font-size: 2vh;\n    padding-right: 10%;\n    position: absolute;\n    text-align: right;\n    top: 90%;\n    width: 100%;\n}\n\n@keyframes blink {\n    0% {\n        opacity: 1;\n    }\n\n    100% {\n        opacity: 0;\n    }\n}\n",""]);const o=h},974:(t,e,i)=>{i.d(e,{Z:()=>o});var s=i(81),n=i.n(s),r=i(645),h=i.n(r)()(n());h.push([t.id,"/* Wrapper of the renderer canvases */\n.cg-renderer-wrapper {\n    position: relative;\n}\n\n/* Renderer canvases */\n.cg-renderer-canvas {\n    height: 100%;\n    position: absolute;\n    width: 100%;\n}\n",""]);const o=h},645:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i="",s=void 0!==e[5];return e[4]&&(i+="@supports (".concat(e[4],") {")),e[2]&&(i+="@media ".concat(e[2]," {")),s&&(i+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),i+=t(e),s&&(i+="}"),e[2]&&(i+="}"),e[4]&&(i+="}"),i})).join("")},e.i=function(t,i,s,n,r){"string"==typeof t&&(t=[[null,t,void 0]]);var h={};if(s)for(var o=0;o<this.length;o++){var a=this[o][0];null!=a&&(h[a]=!0)}for(var l=0;l<t.length;l++){var c=[].concat(t[l]);s&&h[c[0]]||(void 0!==r&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=r),i&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=i):c[2]=i),n&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=n):c[4]="".concat(n)),e.push(c))}},e}},81:t=>{t.exports=function(t){return t[1]}},379:t=>{var e=[];function i(t){for(var i=-1,s=0;s<e.length;s++)if(e[s].identifier===t){i=s;break}return i}function s(t,s){for(var r={},h=[],o=0;o<t.length;o++){var a=t[o],l=s.base?a[0]+s.base:a[0],c=r[l]||0,d="".concat(l," ").concat(c);r[l]=c+1;var u=i(d),g={css:a[1],media:a[2],sourceMap:a[3],supports:a[4],layer:a[5]};if(-1!==u)e[u].references++,e[u].updater(g);else{var _=n(g,s);s.byIndex=o,e.splice(o,0,{identifier:d,updater:_,references:1})}h.push(d)}return h}function n(t,e){var i=e.domAPI(e);return i.update(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;i.update(t=e)}else i.remove()}}t.exports=function(t,n){var r=s(t=t||[],n=n||{});return function(t){t=t||[];for(var h=0;h<r.length;h++){var o=i(r[h]);e[o].references--}for(var a=s(t,n),l=0;l<r.length;l++){var c=i(r[l]);0===e[c].references&&(e[c].updater(),e.splice(c,1))}r=a}}},569:t=>{var e={};t.exports=function(t,i){var s=function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}e[t]=i}return e[t]}(t);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(i)}},216:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},565:(t,e,i)=>{t.exports=function(t){var e=i.nc;e&&t.setAttribute("nonce",e)}},795:t=>{t.exports=function(t){var e=t.insertStyleElement(t);return{update:function(i){!function(t,e,i){var s="";i.supports&&(s+="@supports (".concat(i.supports,") {")),i.media&&(s+="@media ".concat(i.media," {"));var n=void 0!==i.layer;n&&(s+="@layer".concat(i.layer.length>0?" ".concat(i.layer):""," {")),s+=i.css,n&&(s+="}"),i.media&&(s+="}"),i.supports&&(s+="}");var r=i.sourceMap;r&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),e.styleTagTransform(s,t,e.options)}(e,t,i)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},589:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var r=e[s]={id:s,exports:{}};return t[s](r,r.exports,i),r.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;i.g.importScripts&&(t=i.g.location+"");var e=i.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var s=e.getElementsByTagName("script");if(s.length)for(var n=s.length-1;n>-1&&!t;)t=s[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})(),i.nc=void 0,(()=>{class t{constructor(t,e){this.x=t,this.y=e}inside(t){return this.x>=t.x&&this.x<=t.x+t.width&&this.y>=t.y&&this.y<=t.y+t.height}copy(){return new t(this.x,this.y)}add(t){return"number"==typeof t?(this.x+=t,this.y+=t):(this.x+=t.x,this.y+=t.y),this}minus(t){return"number"==typeof t?(this.x-=t,this.y-=t):(this.x-=t.x,this.y-=t.y),this}multiply(t){return"number"==typeof t?(this.x*=t,this.y*=t):(this.x*=t.x,this.y*=t.y),this}divide(t){return"number"==typeof t?(this.x/=t,this.y/=t):(this.x/=t.x,this.y/=t.y),this}}class e{constructor(t,e,i,s,n=1){this.scale=n,this.x=t*this.scale,this.y=e*this.scale,this.width=i*this.scale,this.height=s*this.scale}copy(){return new e(this.x,this.y,this.width,this.height)}spread(){return[this.x,this.y,this.width,this.height]}overlap(t){return this.x+this.width>t.x&&t.x+t.width>this.x&&this.y+this.height>t.y&&t.y+t.height>this.y}}class s{constructor(){this.prevent_freeze=!1,this.summary=()=>({})}destroy(){}}class n extends s{constructor(t,e,i,s){super(),this.text=t,this.rect=e,this.color=i,this.font_size=s}static from(t){return i=this,s=void 0,h=function*(){return t[1]=new e(...t[1]),()=>new n(...t)},new((r=void 0)||(r=Promise))((function(t,e){function n(t){try{a(h.next(t))}catch(t){e(t)}}function o(t){try{a(h.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(n,o)}a((h=h.apply(i,s||[])).next())}));var i,s,r,h}draw(t,e,i){let s=t.getContext("2d");s.save(),s.fillStyle=this.color,s.font=`bold ${this.font_size}px "Microsoft Yahei"`,s.textBaseline="middle",s.textAlign="center",s.fillText(this.text,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2,this.rect.width),s.restore()}}var r=i(379),h=i.n(r),o=i(795),a=i.n(o),l=i(569),c=i.n(l),d=i(565),u=i.n(d),g=i(216),_=i.n(g),p=i(589),f=i.n(p),m=i(734),w={};w.styleTagTransform=f(),w.setAttributes=u(),w.insert=c().bind(null,"head"),w.domAPI=a(),w.insertStyleElement=_(),h()(m.Z,w),m.Z&&m.Z.locals&&m.Z.locals;let b=new Map;function v(t){return new Promise(((e,i)=>{if(b.has(t))e(b.get(t));else{let s=new Image;void 0!==window.static_url&&"/"==t[0]?s.src=`${window.static_url}${t}`:s.src=t,b.set(t,s),s.crossOrigin="Anonymous",s.onload=function(){e(s)},s.onerror=i}}))}class y{constructor(e=-1,i=new t(NaN,NaN),s=""){this.button=e,this.position=i,this.key=s}}class x{constructor(t=document.body){this.parent=t;let e=document.createElement("div");e.className="progress-wrapper",t.appendChild(e);let i=document.createElement("p");i.innerHTML="加载中……",i.className="progress-text",e.appendChild(i)}}class k{constructor(t){this.banned_browsers=t,this.error_message=""}browser_is_banned(){let t=navigator.userAgent.toLowerCase(),e=!1;for(let i of this.banned_browsers)if(i.match(t)){e=!0,this.error_message=i.error;break}return e}}class E extends s{constructor(t,e,i,s=null,n="#ffffff",r="#000000"){super(),this.text=t,this.rect=e,this.font_size=i,this.bg_image=s,this.bg_color=n,this.fg_color=r,this.last_draw_button_state=-1,this.button_held=!1,this.curved=!0,this.prevent_freeze=!0,this.onclick=()=>{},this.rect=this.rect.copy()}draw_curved_border(t){let e=Math.min(this.rect.width,this.rect.height)/10;t.beginPath(),t.moveTo(this.rect.x+e,this.rect.y),t.lineTo(this.rect.x+this.rect.width-e,this.rect.y),t.arcTo(this.rect.x+this.rect.width,this.rect.y,this.rect.x+this.rect.width,this.rect.y+e,e),t.lineTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height-e),t.arcTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height,this.rect.x+this.rect.width-e,this.rect.y+this.rect.height,e),t.lineTo(this.rect.x+e,this.rect.y+this.rect.height),t.arcTo(this.rect.x,this.rect.y+this.rect.height,this.rect.x,this.rect.y+this.rect.height-e,e),t.lineTo(this.rect.x,this.rect.y+e),t.arcTo(this.rect.x,this.rect.y,this.rect.x+e,this.rect.y,e)}draw_border(t){t.beginPath(),t.moveTo(this.rect.x,this.rect.y),t.lineTo(this.rect.x+this.rect.width,this.rect.y),t.lineTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height),t.lineTo(this.rect.x,this.rect.y+this.rect.height),t.lineTo(this.rect.x,this.rect.y)}draw_foreground(t){t.font=`${this.font_size}px "Microsoft YaHei"`,t.textBaseline="middle",t.textAlign="center",t.fillStyle=this.fg_color,t.fillText(this.text,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2,this.rect.width)}draw(t,e,i){let s=t.getContext("2d"),n=i.position.inside(this.rect);-1==this.last_draw_button_state&&0==i.button&&n?this.button_held=!0:-1==i.button&&(this.button_held&&n&&this.onclick(),this.button_held=!1),s.save(),n&&0!=i.button||this.button_held?s.globalAlpha=.6:s.globalAlpha=1,this.curved?this.draw_curved_border(s):this.draw_border(s),null==this.bg_image?(s.fillStyle=this.bg_color,s.fill()):(s.clip(),s.drawImage(this.bg_image,this.rect.x,this.rect.y,this.rect.width,this.rect.height)),this.draw_foreground(s),s.restore(),this.last_draw_button_state=i.button}}class M extends E{constructor(t,i,s=null,n=!0){if(super("",t,0,i),this.fg_image=s,this.selected=!1,this.onclick=()=>{this.selected=!this.selected},this.summary=()=>({whereabout:this.selected}),this.curved=n,null!=this.fg_image){let t,i,s=.6,n=this.fg_image.width/this.fg_image.height;n>=this.rect.width/this.rect.height?(t=this.rect.width*s,i=t/n):(i=this.rect.height*s,t=i*n),this.foreground_rect=new e(this.rect.x+this.rect.width/2-t/2,this.rect.y+this.rect.height/2-i/2,t,i)}}static from(t){return i=this,s=void 0,r=function*(){return t[0]=new e(...t[0]),t[1]=yield v(t[1]),t.length>=3&&(""==t[2]?t[2]=null:t[2]=yield v(t[2])),()=>new M(...t)},new((n=void 0)||(n=Promise))((function(t,e){function h(t){try{a(r.next(t))}catch(t){e(t)}}function o(t){try{a(r.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}a((r=r.apply(i,s||[])).next())}));var i,s,n,r}draw_foreground(t){t.save(),t.globalAlpha=1,null!=this.fg_image&&t.drawImage(this.fg_image,this.foreground_rect.x,this.foreground_rect.y,this.foreground_rect.width,this.foreground_rect.height),this.selected&&(t.globalAlpha=.4,t.fillStyle="#000000",this.curved?this.draw_curved_border(t):this.draw_border(t),t.fill()),t.restore()}draw(t,e,i){super.draw(t,e,i)}}class T extends s{constructor(t){super(),this.children=t,this.prevent_freeze=!0,this.selected=-1,this.summary=()=>({whereabout:this.selected});let e=0;for(let t of this.children){let i=e;t.onclick=()=>{if(t.selected)t.selected=!1,this.selected=-1;else{t.selected=!0,this.selected=i;for(let t=0;t<this.children.length;t++)t!=i&&(this.children[t].selected=!1)}},e++}}static from(t){return e=this,i=void 0,n=function*(){let e=[];for(let i of t)i=i.slice(),i.push(""),i.push(!1),e.push(yield M.from(i));return()=>new T(e.map((function(t){return t()})))},new((s=void 0)||(s=Promise))((function(t,r){function h(t){try{a(n.next(t))}catch(t){r(t)}}function o(t){try{a(n.throw(t))}catch(t){r(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n}draw(t,e,i){for(let s of this.children)s.draw(t,e,i)}}class L extends s{constructor(t,e="#ffffff"){super(),this.rect=t,this.color=e,this.rect=this.rect.copy()}draw(t,e,i){let s=t.getContext("2d");s.save(),s.fillStyle=this.color,s.fillRect(...this.rect.spread()),s.restore()}}var z=i(655),C={};C.styleTagTransform=f(),C.setAttributes=u(),C.insert=c().bind(null,"head"),C.domAPI=a(),C.insertStyleElement=_(),h()(z.Z,C),z.Z&&z.Z.locals&&z.Z.locals;const $=i.p+"5ffd5abb4314a1190ee6.png";class A extends s{constructor(t,i=""){super(),this.rect=t,this.content=i,this.text_element=document.createElement("div"),this.aspect_ratio=1.466,this.text_element.innerHTML=`<p>${this.content}</p>`,this.text_element.classList.add("cg-component-dialog-text-renderer"),this.rect.height<0||this.rect.width>0&&this.rect.height>0?this.rect.height=this.rect.width/this.aspect_ratio:this.rect.width=this.rect.height*this.aspect_ratio,this.rect=this.rect.copy(),this.text_rect=new e(this.rect.x+this.rect.width*(3.57/12.41),this.rect.y+this.rect.height*(1.79/8.47),this.rect.width*(6.29/12.41),this.rect.height*(2.58/8.47))}static from(t){return i=this,s=void 0,r=function*(){return t[0]=new e(...t[0]),()=>new A(t[0],t[1])},new((n=void 0)||(n=Promise))((function(t,e){function h(t){try{a(r.next(t))}catch(t){e(t)}}function o(t){try{a(r.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}a((r=r.apply(i,s||[])).next())}));var i,s,n,r}static load(){v($).then((t=>{A.dialog_text_box=t}))}draw(t,e,i){if(null==A.dialog_text_box)return void A.load();t.getContext("2d").drawImage(A.dialog_text_box,...this.rect.spread());let s=Number(getComputedStyle(t).width.replace("px",""))/t.width;this.text_element.style.left=this.text_rect.x*s+"px",this.text_element.style.top=this.text_rect.y*s+"px",this.text_element.style.transform=`scale(${this.text_rect.width*s/1258})`,t.parentElement.appendChild(this.text_element)}destroy(){this.text_element.remove()}}A.dialog_text_box=null,A.load();class S extends s{constructor(t,e=null,i=!1){super(),this.image=t,this.rect=e,this.rect=this.rect.copy(),this.prevent_freeze=i}static from(t){return i=this,s=void 0,r=function*(){return t[0]=yield v(t[0]),t[1]=new e(...t[1]),()=>new S(...t)},new((n=void 0)||(n=Promise))((function(t,e){function h(t){try{a(r.next(t))}catch(t){e(t)}}function o(t){try{a(r.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}a((r=r.apply(i,s||[])).next())}));var i,s,n,r}draw(t,e,i){let s=t.getContext("2d");null!=this.rect?s.drawImage(this.image,this.rect.x,this.rect.y,this.rect.width,this.rect.height):s.drawImage(this.image,0,0,this.image.naturalWidth,this.image.naturalHeight)}}class j extends S{constructor(t,e,i=!1){super(t,e),this.flash=i,this.flash_curve=(1,.2,.2,1,function(t){return 1*Math.pow(t,3)+3*.2*Math.pow(t,2)*(1-t)+3*.2*t*Math.pow(1-t,2)+1*Math.pow(1-t,3)}),this.period=2e3,this.start_time=-1,this.last_draw_button_state=-1,this.button_held=!1,this.onclick=()=>{},this.prevent_freeze=!0,this.rect=this.rect.copy()}draw(t,e,i){let s=t.getContext("2d"),n=i.position.inside(this.rect);if(-1==this.last_draw_button_state&&0==i.button&&n?this.button_held=!0:-1==i.button&&(this.button_held&&n&&this.onclick(),this.button_held=!1),-1==this.start_time&&(this.start_time=performance.now()),s.save(),this.flash){let t=(performance.now()-this.start_time)%this.period/this.period;s.globalAlpha=this.flash_curve(t)}super.draw(t,e,i),s.restore()}}class N extends s{constructor(t,e){super(),this.content=t,this.rect=e,this.disable_scroll=!1,this.scroll_bar_width=this.rect.width/100,this.is_scrolling=!1,this.last_draw_button_status=-1,this.button_down_position=null,this.button_down_progress=null,this.mouse_wheel_scroll=0,this.mouse_wheel_callback=t=>{this.mouse_wheel_scroll=t.deltaY},this.has_reached_bottom=!1,this.prevent_freeze=!0,this.rect=this.rect.copy(),this.scale_factor=e.width/t.width,this.min_progress=Math.min(e.height/(t.height*this.scale_factor),1),this.progress=this.min_progress,this.disable_scroll=e.height>=t.height*this.scale_factor,this.disable_scroll&&(this.prevent_freeze=!1,this.has_reached_bottom=!0),window.addEventListener("wheel",this.mouse_wheel_callback)}get_scroll_thumb_rect(t=this.progress){return t=Math.min(Math.max(t,this.min_progress),1),new e(this.rect.x+this.rect.width,this.rect.y+this.rect.height*(this.progress-this.min_progress),this.scroll_bar_width,this.rect.height*this.min_progress)}draw(t,i,s){let n=t.getContext("2d");if(n.save(),n.beginPath(),n.rect(...this.rect.spread()),n.clip(),n.drawImage(this.content,this.rect.x,this.rect.y-this.content.height*this.scale_factor*(this.progress-this.min_progress),this.rect.width,this.content.height*this.scale_factor),n.restore(),!this.disable_scroll){let t=this.progress;0==this.mouse_wheel_scroll&&0==s.button?-1==this.last_draw_button_status&&(s.position.inside(this.get_scroll_thumb_rect())?(this.is_scrolling=!0,this.button_down_position=s.position.y,this.button_down_progress=this.progress):s.position.inside(new e(this.rect.x+this.rect.width,this.rect.y,this.scroll_bar_width,this.rect.height))&&(this.is_scrolling=!1,t=(s.position.y-this.rect.y)/this.rect.height+this.min_progress,this.progress=Math.min(Math.max(t,this.min_progress),1))):this.is_scrolling=!1,this.is_scrolling?(t=(s.position.y-this.button_down_position)/this.rect.height+this.button_down_progress,this.progress=Math.min(Math.max(t,this.min_progress),1)):0!=this.mouse_wheel_scroll&&(t+=this.mouse_wheel_scroll/(this.content.height*(document.documentElement.clientWidth/this.content.width)),this.progress=Math.min(Math.max(t,this.min_progress),1),this.mouse_wheel_scroll=0),n.save(),n.fillStyle="#F1F1F1",n.fillRect(this.rect.x+this.rect.width,this.rect.y,this.scroll_bar_width,this.rect.height),n.fillStyle=this.is_scrolling?"#787878":"#A8A8A8",n.fillRect(this.rect.x+this.rect.width,this.rect.y+this.rect.height*(this.progress-this.min_progress),this.scroll_bar_width,this.rect.height*this.min_progress),n.restore(),this.last_draw_button_status=s.button,this.progress>=.95&&(this.has_reached_bottom=!0)}}destroy(){window.removeEventListener("wheel",this.mouse_wheel_callback)}}class I extends s{constructor(t,e){super(),this.initial_time=t,this.rect=e,this.start_time=-1,this.prevent_freeze=!0,this.rect=this.rect.copy(),this.initial_time=Math.max(Math.min(this.initial_time,3599),0),this.rect.width<0?this.rect.width=this.rect.height*I.aspect_ratio:this.rect.height=this.rect.width/I.aspect_ratio,this.time=this.initial_time}get finished(){return 0==this.time}draw(t,e,i){let s=t.getContext("2d");-1==this.start_time&&(this.start_time=performance.now()),this.time=Math.max(Math.round(this.initial_time-(performance.now()-this.start_time)/1e3),0);let n=Math.floor(this.time/60),r=this.time-60*n,h=`${`0${n}`.slice(-2)} : ${`0${r}`.slice(-2)}`;s.save(),s.fillStyle="#252525",s.globalAlpha=.6,s.fillRect(...this.rect.spread()),s.textAlign="center",s.textBaseline="middle",s.font=`bold ${this.rect.height/2}px "Microsoft Yahei"`,s.fillStyle="#A52A2A",s.globalAlpha=1,s.fillText(h,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2),s.restore()}}I.aspect_ratio=3;var P=i(974),F={};F.styleTagTransform=f(),F.setAttributes=u(),F.insert=c().bind(null,"head"),F.domAPI=a(),F.insertStyleElement=_(),h()(P.Z,F),P.Z&&P.Z.locals&&P.Z.locals;class Z{constructor(e,i,s,n=1){this.width=i,this.height=s,this.ratio=n,this.frozen_content=null,this.draw_call_list=[],this.backup_draw_call_list=[],this.event=new y,this.cursor_is_set=!1,this.should_redraw=!1,this.force_freeze=!1,this.button_down_event_listener=t=>{-1==this.event.button&&(this.event.button=t.button)},this.button_move_event_listener=e=>{let i=this.front_buffer_canvas.getBoundingClientRect();this.event.position=new t(e.clientX-i.x,e.clientY-i.y).divide(this.ratio)},this.button_up_event_listener=t=>{t.button==this.event.button&&(this.event.button=-1)},this.key_down_listener=t=>{""==this.event.key&&(this.event.key=t.key)},this.key_up_listener=t=>{t.key==this.event.key&&(this.event.key="")},this.animationFrameRequestId=null,e.innerHTML="",this.parent=document.createElement("div"),this.parent.className="cg-renderer-wrapper",this.parent.style.width=i*n+"px",this.parent.style.height=s*n+"px",e.appendChild(this.parent),this.back_buffer_canvas=this.create_canvas(),this.back_buffer=this.back_buffer_canvas.getContext("2d",{willReadFrequently:!0}),this.front_buffer_canvas=this.create_canvas(),this.front_buffer=this.front_buffer_canvas.getContext("2d"),document.addEventListener("keydown",this.key_down_listener),document.addEventListener("keyup",this.key_up_listener),this.front_buffer_canvas.addEventListener("mousedown",this.button_down_event_listener),this.front_buffer_canvas.addEventListener("mouseup",this.button_up_event_listener),document.addEventListener("mouseup",this.button_up_event_listener),document.addEventListener("mousemove",this.button_move_event_listener),G.on("set-cursor",(t=>{this.cursor_is_set||(this.front_buffer_canvas.style.cursor=t,"pointer"==t&&(this.cursor_is_set=!0))})),window.addEventListener("contextmenu",(t=>{t.preventDefault()}))}create_canvas(){let t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.classList.add("cg-renderer-canvas"),this.parent.appendChild(t),t}clear_buffer(t){t.clearRect(0,0,this.width,this.height)}frame(){let i;if(this.cursor_is_set=!1,this.clear_buffer(this.back_buffer),i=this.force_freeze?{button:-1,position:new t(-1,-1),key:""}:this.event,this.should_redraw){for(let t of this.draw_call_list)t.freeze&&t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),i);this.frozen_content=this.back_buffer.getImageData(0,0,this.width,this.height),this.clear_buffer(this.back_buffer),this.should_redraw=!1}null!=this.frozen_content&&this.back_buffer.putImageData(this.frozen_content,0,0);for(let t of this.draw_call_list)t.freeze||t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),i);this.clear_buffer(this.front_buffer),this.front_buffer.drawImage(this.back_buffer_canvas,0,0),this.animationFrameRequestId=window.requestAnimationFrame(this.frame.bind(this))}setHeight(t){this.ratio=t/this.height,this.parent.style.width=t/this.height*this.width+"px",this.parent.style.height=`${t}px`,this.should_redraw=!0}addEventListener(t,e,i=null){this.front_buffer_canvas.addEventListener(t,e,i)}removeEventListener(t,e,i=null){this.front_buffer_canvas.removeEventListener(t,e,i)}draw(t,e=!0){t.prevent_freeze&&(e=!1),this.backup_draw_call_list.push({component:t,freeze:e})}render(t=!1){this.force_freeze=t,this.clear(),this.draw_call_list=this.backup_draw_call_list,this.backup_draw_call_list=[];for(let t of this.draw_call_list)t.freeze&&t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),this.event);this.frozen_content=this.back_buffer.getImageData(0,0,this.width,this.height),this.clear_buffer(this.back_buffer),this.frame()}clear(){null!=this.animationFrameRequestId&&(window.cancelAnimationFrame(this.animationFrameRequestId),this.animationFrameRequestId=null);for(let t of this.draw_call_list)t.component.destroy();this.clear_buffer(this.back_buffer),this.clear_buffer(this.front_buffer),this.draw_call_list=[],this.frozen_content=null}destroy(){document.removeEventListener("keydown",this.key_down_listener),document.removeEventListener("keyup",this.key_up_listener),this.front_buffer_canvas.removeEventListener("mousedown",this.button_down_event_listener),this.front_buffer_canvas.removeEventListener("mouseup",this.button_up_event_listener),document.removeEventListener("mouseup",this.button_up_event_listener),document.removeEventListener("mousemove",this.button_move_event_listener),this.parent.remove()}}var q=i(303),R={};R.styleTagTransform=f(),R.setAttributes=u(),R.insert=c().bind(null,"head"),R.domAPI=a(),R.insertStyleElement=_(),h()(q.Z,R),q.Z&&q.Z.locals&&q.Z.locals;const H=i.p+"8c54d1d41902b0d9aece.png",O=i.p+"07affb794335470e2f64.png",W=i.p+"f2e50899fcdfb12dcec4.jpg",B=i.p+"67ea60c3639a4f248416.png",D=i.p+"ee6237f24b09b656f81e.png",Y=i.p+"55f491b078881f8488aa.png";class J extends S{constructor(t,e,i=!1,s=null,n=!1,r=!0){super(t,e),this.restore_position_upon_loose=i,this.target_area=s,this.absorb=n,this.show_target_area=r,this.is_moving=!1,this.last_draw_button_status=-1,this.prevent_freeze=!0,this.whereabout=-1,this.summary=()=>({whereabout:this.whereabout}),this.default_rect=e.copy()}static from(t){return i=this,s=void 0,r=function*(){if(t[0]=yield v(t[0]),t[1]=new e(...t[1]),t.length>=4){let i=[];for(let s of t[3])i.push(new e(...s));t[3]=i}return()=>new J(...t)},new((n=void 0)||(n=Promise))((function(t,e){function h(t){try{a(r.next(t))}catch(t){e(t)}}function o(t){try{a(r.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}a((r=r.apply(i,s||[])).next())}));var i,s,n,r}static_draw(t,e,i){super.draw(t,e,i)}draw(t,e,i){J.registered_list.has(this)||J.registered_list.set(this,!1);let s=!0;if(!this.is_moving){let t=Array.from(J.registered_list.keys());for(let e=t.indexOf(this)+1;e<t.length;e++)if(i.position.inside(t[e].rect)){s=!1;break}}let n=this.is_moving;s&&(0==i.button&&(-1==this.last_draw_button_status&&i.position.inside(this.rect)||this.is_moving)?this.is_moving=!0:this.is_moving=!1),this.last_draw_button_status=i.button;let r=s=>{if(this.show_target_area){let n=t.getContext("2d"),r=n.fillStyle;n.fillStyle="#cce099",n.fillRect(s.x,s.y,s.width,s.height),n.fillStyle=r;let h=Array.from(J.registered_list.keys());for(let n=0;n<h.indexOf(this);n++)h[n].rect.overlap(s)&&h[n].static_draw(t,e,i)}return!0};if(this.is_moving){let t=i.position.x-this.rect.width/2,s=i.position.y-this.rect.height/2;if(this.rect.x=Math.min(Math.max(0,t),e.width-this.rect.width),this.rect.y=Math.min(Math.max(0,s),e.height-this.rect.height),Array.isArray(this.target_area))for(let t of this.target_area)r(t);else null!=this.target_area&&r(this.target_area)}else if(n)if(this.absorb){let t=!1;if(Array.isArray(this.target_area)){let e=0;for(let s of this.target_area){if(i.position.inside(s)){this.rect.x=s.x+s.width/2-this.rect.width/2,this.rect.y=s.y+s.height/2-this.rect.height/2,t=!0,this.whereabout=e;break}e++}}else null!=this.target_area&&i.position.inside(this.target_area)&&(this.rect.x=this.target_area.x+this.target_area.width/2-this.rect.width/2,this.rect.y=this.target_area.y+this.target_area.height/2-this.rect.height/2,t=!0,this.whereabout=0);t||(this.restore_position_upon_loose&&this.restore_default_position(),this.whereabout=-1)}else if(this.restore_position_upon_loose)this.restore_default_position();else if(Array.isArray(this.target_area)){let t=0;for(let e of this.target_area){if(i.position.inside(e)){this.whereabout=t;break}t++}}else null!=this.target_area&&i.position.inside(this.target_area)&&(this.whereabout=0);super.draw(t,e,i)}restore_default_position(){this.rect=this.default_rect.copy()}destroy(){J.registered_list.delete(this)}}J.registered_list=new Map;var U,X=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function h(t){try{a(s.next(t))}catch(t){r(t)}}function o(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}a((s=s.apply(t,e||[])).next())}))};class G{constructor(t,e=document.body){let i;this.course=t,this.parent=e,this.is_alert=!1,this.is_picking_session=!1,this.is_showing_menu=!1,this.alert_modal=null,this.game_progress=window.progress,this.csrf_token=document.getElementsByName("csrfmiddlewaretoken")[0].value,this.global_callbacks=new Map,this.resize_callback=()=>{document.documentElement.clientWidth/document.documentElement.clientHeight>this.width/this.height?this.renderer.setHeight(document.documentElement.clientHeight):this.renderer.setHeight(document.documentElement.clientWidth/this.width*this.height)},this.keyup_callback=t=>{"Escape"==t.key&&this.menu()},this.width=3200,this.height=1800,this.game_content=new Array(this.course.sessions.length),this.about_text="",this.parent.classList.add("cg-game"),i=document.documentElement.clientWidth/document.documentElement.clientHeight>this.width/this.height?document.documentElement.clientHeight/this.height:document.documentElement.clientWidth/this.width,this.renderer=new Z(this.parent,this.width,this.height,i),window.addEventListener("resize",this.resize_callback),document.addEventListener("keyup",this.keyup_callback)}static message(t,e=null){this.event_list.push({event:t,param:e})}static on(t,e){this.event_listeners.has(t)?(this.event_listeners.set(t,e),console.warn(`Event ${t} has already been registered and is now replaced by another by the same name`)):this.event_listeners.set(t,e)}static parse_component(t){return X(this,void 0,void 0,(function*(){let e,i=t.params.slice();switch(t.name.toLowerCase()){case"dialog":e=yield A.from(i);break;case"drag":e=yield J.from(i);break;case"img":e=yield S.from(i);break;case"select":e=yield M.from(i);break;case"single-select":e=yield T.from(i);break;case"text":e=yield n.from(i)}return e}))}static parse_scene(t){return X(this,void 0,void 0,(function*(){let e={};e.question=t.question;let i=[];for(let e of t.layout)i.push(yield this.parse_component(e));return e.layout=()=>{let t=[];for(let e of i)t.push(e());return t},e.correct_func=t.correct_func,e}))}static parse_level(t){return X(this,void 0,void 0,(function*(){let i={};i.position=new e(...t.position),i.paper=yield v(t.paper),i.prompt=t.prompt,i.correct=t.correct.slice(),i.objects=[];for(let e of t.objects)i.objects.push(yield v(e));i.scenes=[];for(let e of t.scenes)i.scenes.push(yield this.parse_scene(e));return i}))}static parse_session(t){return X(this,void 0,void 0,(function*(){let e={};e.map=yield v(t.map),e.background=yield v(t.background),e.marker=yield v(t.marker),e.levels=[];for(let i of t.levels)e.levels.push(yield this.parse_level(i));return e}))}static parse_course(t){return X(this,void 0,void 0,(function*(){let e={};return e.map=yield v(t.map),e.finished_marker=yield v(t.finished_marker),e.unfinished_marker=yield v(t.unfinished_marker),e}))}validate_progress(t,e){return this.game_progress.session>t||this.game_progress.session==t&&this.game_progress.level>=e}update_progress(t,e){return X(this,void 0,void 0,(function*(){let i=[];for(let t of e)i.push(t.summary());return new Promise((e=>{this.game_progress=t,fetch(window.location.href,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrf_token},body:JSON.stringify(Object.assign({summary:i},this.game_progress)),credentials:"same-origin"}).then((t=>t.text())).then((t=>{e(Number(t))}))}))}))}pick_session(){this.is_picking_session=!0,this.renderer.removeEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.draw(new S(this.course.map,new e(0,0,this.width,this.height)));for(let t=0;t<this.course.sessions.length;t++){let i,s=this.course.sessions[t];if(t<this.game_progress.session)i=new j(this.course.finished_marker,s.position);else{if(t!=this.game_progress.session)continue;i=new j(this.course.unfinished_marker,s.position)}let r=.015*this.height,h=10*r,o=3*r,a=new e(s.position.x+s.position.width/2-h/2,s.position.y-1.2*o,h,o);this.renderer.draw(new L(a,"rgba(0, 0, 0, 0.5)")),this.renderer.draw(new n(this.course.sessions[t].name,a,"#FFFFFF",r)),i.onclick=()=>X(this,void 0,void 0,(function*(){if(void 0===this.game_content[t]){let e=yield U.parse_session(this.course.sessions[t].get);this.game_content[t]=e,this.pick_level(t)}else this.pick_level(t)})),this.renderer.draw(i)}this.renderer.render()}pick_level(t){this.is_picking_session=!1;let i=this.game_progress;if(t>i.session)return void console.error(`current session: ${t}\nprogress session: ${i.session}`);let s,n=this.game_content[t];this.renderer.draw(new S(n.map,new e(0,0,this.width,this.height))),s=i.session>t?n.levels.length:i.level;for(let e=0;e<s;e++){let i=new j(n.marker,n.levels[e].position);i.onclick=()=>{this.read_paper(t,e)},this.renderer.draw(i)}if(s!=n.levels.length){let e=new j(n.marker,n.levels[s].position,!0);e.onclick=()=>{this.read_paper(t,s)},this.renderer.draw(e)}this.renderer.render()}read_paper(t,i,s=null){this.is_picking_session=!1;let n=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${n.session}, level: ${n.level}`);let r=this.game_content[t],h=r.levels[i];this.renderer.draw(new S(r.background,new e(0,0,this.width,this.height)));let o,a=new N(h.paper,new e(this.width/16,this.height/6,7*this.width/8,2*this.height/3));this.renderer.draw(a),o=null==s?n.session>t||n.level>i?20:60:s;let l=new I(o,new e(this.width/2-this.height/9*I.aspect_ratio/2,this.height/36,this.height/9*I.aspect_ratio,this.height/9));this.renderer.draw(l);let c=new E("",new e(this.width/2-this.height/18*(this.button_background.width/this.button_background.height),this.height-this.height/36-this.height/9,this.height/9*(this.button_background.width/this.button_background.height),this.height/9),this.height/18,this.button_background,"#000000","#351500");c.onclick=()=>{a.has_reached_bottom?l.finished?this.prompt_object_selection(t,i):this.alert(`你需要至少阅读${o}秒才能继续游戏~`):this.alert("你需要看完文献的全部内容才能继续游戏~")},this.renderer.draw(c),this.renderer.render()}prompt_object_selection(t,i){this.is_picking_session=!1;let s=this.game_progress;this.validate_progress(t,i)?(this.renderer.draw(new S(this.object_select_background,new e(0,0,this.width,this.height))),this.renderer.draw(new S(this.speaker,new e(this.height/6,this.height/3,this.height/3,this.height/3))),this.alert(this.game_content[t].levels[i].prompt,(()=>{this.select_object(t,i)}),!1),this.renderer.render()):console.error(`requested session: ${t}, level: ${i}\nprogress session: ${s.session}, level: ${s.level}`)}select_object(t,i){this.is_picking_session=!1;let s=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${s.session}, level: ${s.level}`);let n=this.game_content[t].levels[i].objects,r=this.game_content[t].levels[i].correct;this.renderer.draw(new S(this.object_select_background,new e(0,0,this.width,this.height)));let h=[],o=this.height*(2/3)/32,a=this.height*(2/3)/3.2;for(let t=0;t<9;t++){let i=Math.floor(t/3),s=t%3;h[t]=new M(new e(this.width/2-this.height/3+a*s+o*s,this.height/6+a*i+o*i,a,a),this.object_select_grid,n[t]),this.renderer.draw(h[t])}let l=new E("",new e(this.width/2-this.height/18*(this.button_background.width/this.button_background.height),this.height-this.height/36-this.height/9,this.height/9*(this.button_background.width/this.button_background.height),this.height/9),this.height/18,this.button_background,"#000000","#351500");l.onclick=()=>{let e=!0;for(let t=0;t<9;t++){let i=h[t];if(i.selected&&-1==r.indexOf(t)||!i.selected&&-1!=r.indexOf(t)){e=!1;break}}if(e){let e;e=s.session>t||s.level>i?0:s.scene,this.play_scene(t,i,e)}else this.alert("选择错误，请重新选择~",(()=>{this.prompt_object_selection(t,i)}))},this.renderer.draw(l),this.renderer.render()}play_scene(t,i,s){this.is_picking_session=!1;let r=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${r.session}, level: ${r.level}`);s=Math.floor(s);let h=this.game_content[t],o=h.levels[i],a=o.scenes[s],l=r.session>t||r.level>i,c=!l&&-1==r.scene.toString().indexOf(".5");this.renderer.draw(new S(h.background,new e(0,0,this.width,this.height))),this.renderer.draw(new S(this.play_bar,new e(.125*this.width,.015*this.height,.75*this.width,.125*this.height))),this.renderer.draw(new L(new e(.125*this.width,.15*this.height,.75*this.width,.7*this.height))),this.renderer.draw(new n(`关卡${Math.floor(i)+1}（共${h.levels.length}关）: ${Math.floor(s)+1} / ${o.scenes.length}`,new e(.625*this.width,.015*this.height,.25*this.width,.125*this.height),"#000000",.03*this.height));let d=a.layout();for(let t of d)this.renderer.draw(t);this.renderer.draw(new S(this.speaker,new e(0,this.height-this.height/3,this.height/3,this.height/3)));let u,g=new A(new e(this.height/4,this.height-this.height/2-.23*this.height,-1,this.height/2),a.question);g.prevent_freeze=!0,this.renderer.draw(g),l||(u=new I(c?10:5,new e(.14*this.width,.045*this.height,-1,.065*this.height)),this.renderer.draw(u)),this.global_callbacks.set("finish-dialog",(()=>{if(l||void 0!==u&&u.finished){this.renderer.draw(new S(h.background,new e(0,0,this.width,this.height))),this.renderer.draw(new S(this.play_bar,new e(.125*this.width,.015*this.height,.75*this.width,.125*this.height))),this.renderer.draw(new L(new e(.125*this.width,.15*this.height,.75*this.width,.7*this.height))),this.renderer.draw(new n(`关卡${Math.floor(i)+1}（共${h.levels.length}关）: ${Math.floor(s)+1} / ${o.scenes.length}`,new e(.625*this.width,.015*this.height,.25*this.width,.125*this.height),"#000000",.03*this.height));let c=new E("查看问题",new e(.14*this.width,.045*this.height,.195*this.height,.065*this.height),.03*this.height,null,"rgba(0, 0, 0, 0)","#000000");c.onclick=()=>{this.alert(a.question)},this.renderer.draw(c);for(let t of d)this.renderer.draw(t);let u=.1*this.height,g=u*(this.button_background.width/this.button_background.height),_=new E("",new e(this.width/2-g/2,.875*this.height,g,u),16,this.button_background);_.onclick=()=>{if(a.correct_func(d)){let e;++s>=o.scenes.length&&(s=0,++i>=h.levels.length&&(i=0,t++)),e=0==i&&0==s?"已完成本章全部关卡！":0==s?"恭喜你，成功完成本关卡！<br>快去下一关看看吧！":"太棒了！操作正确！<br>请接着做后面的实验吧！",this.alert(e,(()=>{let e,n;l?(e=r,n=new Promise((t=>{t(1)}))):(e={session:t,level:i,scene:s},n=this.update_progress(e,d)),n.then((e=>{0!=e&&0==i&&0==s?this.pick_session():0==s?this.pick_level(t):this.play_scene(t,i,s)}))}))}else if(l)this.alert("太遗憾了，你的操作是错误的！<br>请再试试吧！",(()=>{this.play_scene(t,i,s)}));else{let e={session:t,level:i,scene:Math.floor(s)+.5};this.update_progress(e,d).then((()=>{this.alert("太遗憾了，你的操作是错误的！<br>回到文献中再看看吧！",(()=>{this.read_paper(t,i,20)}))}))}},this.renderer.draw(_),this.renderer.removeEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.render()}})),this.renderer.addEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.render(!0)}alert(t,e=null,i=!0){if(!this.is_alert){this.is_alert=!0,this.alert_modal.querySelector(".cg-game-alert-text").innerHTML=`<p>${t}</p>`,this.alert_modal.style.display="flex",i&&this.alert_modal.classList.add("cg-game-alert-blur");let s=()=>{this.alert_modal.style.display="none",this.is_alert=!1,this.alert_modal.classList.remove("cg-game-alert-blur"),null!=e&&e()};this.alert_modal.querySelector(".cg-game-alert-confirm").addEventListener("click",s,{once:!0})}}menu(){if(this.is_alert||this.is_showing_menu)this.is_showing_menu&&(this.renderer.parent.querySelector(".menu-modal").remove(),this.is_showing_menu=!1);else{this.is_showing_menu=!0;let t=document.createElement("div");if(t.className="menu-modal",this.renderer.parent.appendChild(t),!this.is_picking_session){let e=document.createElement("div");e.className="menu-option",e.innerText="返回主界面",t.appendChild(e);let i=()=>{t.remove(),this.is_showing_menu=!1,this.pick_session()};e.addEventListener("click",i,{once:!0})}let e=document.createElement("div");e.className="menu-option",e.innerText="关闭菜单",t.appendChild(e);let i=()=>{t.remove(),this.is_showing_menu=!1};e.addEventListener("click",i,{once:!0});let s=document.createElement("div");s.className="menu-option",s.innerText="返回首页",t.appendChild(s);let n=()=>{t.remove(),this.is_showing_menu=!1,window.location.href="/"};s.addEventListener("click",n,{once:!0});let r=document.createElement("div");r.className="menu-option",r.innerText="关于游戏",t.appendChild(r);let h=()=>{t.remove(),this.is_showing_menu=!1,this.about()};r.addEventListener("click",h,{once:!0});let o=document.createElement("div");o.className="menu-option",o.innerText="退出登录",t.appendChild(o);let a=()=>{t.remove(),this.is_showing_menu=!1,this.logout()};o.addEventListener("click",a,{once:!0})}}about(){this.is_alert=!0;let t=document.createElement("div");t.className="about-modal",this.renderer.parent.appendChild(t);let e=document.createElement("div");e.id="about-content",t.appendChild(e),e.innerHTML=this.about_text;let i=document.createElement("div");i.id="about-close",i.innerText="关闭",e.appendChild(i),i.addEventListener("click",(()=>{t.remove(),this.is_alert=!1}))}logout(){window.open("/logout","_self")}load(){return X(this,void 0,void 0,(function*(){this.button_background=yield v(H),this.object_select_grid=yield v(O),this.object_select_background=yield v(W),this.speaker=yield v(D),this.play_bar=yield v(Y)}))}start(){return X(this,void 0,void 0,(function*(){yield this.load();let t=document.createElement("div");t.className="cg-game-alert",t.style.display="none",this.renderer.parent.appendChild(t);let e=document.createElement("div");e.className="cg-game-alert-window",t.appendChild(e);let i=document.createElement("img");i.className="cg-game-alert-background",i.src=B,e.appendChild(i);let s=document.createElement("div");s.className="cg-game-alert-text",e.appendChild(s);let n=document.createElement("img");n.className="cg-game-alert-confirm",n.src=H,e.appendChild(n),this.alert_modal=t,this.pick_session()}))}destroy(){window.removeEventListener("resize",this.resize_callback),document.removeEventListener("keyup",this.keyup_callback)}}U=G,G.event_listeners=new Map,G.event_list=[],G.event_processor=window.setInterval((()=>{for(let t of U.event_list)U.event_listeners.has(t.event)&&U.event_listeners.get(t.event)(t.param);U.event_list=[]}),0);!function(){var t,i,s,n;t=this,i=void 0,n=function*(){let t=new k([{match:function(t){return/safari/.test(t)&&!/chrome/.test(t)},error:"小游戏暂时不支持 Safari 浏览器，请使用 Chrome 或 Edge 等浏览器代替"}]);if(t.browser_is_banned())return void alert(t.error_message);new x,void 0!==window.image_list&&(yield Promise.all(window.image_list.map(v)));let i=yield v(window.game_map),s=yield v(window.finished_marker),n=yield v(window.unfinished_marker),r=[];for(let t of window.sessions)r.push({position:new e(...t.position),get:t.get,name:t.name});window.sessions=[];let h=new G({map:i,finished_marker:s,unfinished_marker:n,sessions:r});h.about_text=window.about_text,yield h.start()},new((s=void 0)||(s=Promise))((function(e,r){function h(t){try{a(n.next(t))}catch(t){r(t)}}function o(t){try{a(n.throw(t))}catch(t){r(t)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(t,i||[])).next())}))}()})()})();