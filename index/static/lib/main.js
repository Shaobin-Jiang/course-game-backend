(()=>{"use strict";var t={655:(t,e,i)=>{i.d(e,{Z:()=>o});var r=i(81),s=i.n(r),n=i(645),h=i.n(n)()(s());h.push([t.id,".cg-component-dialog-text-renderer {\r\n    align-items: center;\r\n    cursor: default;\r\n    display: flex;\r\n    font-size: 64px;\r\n    height: 516px;\r\n    overflow: hidden;\r\n    position: absolute;\r\n    transform-origin: left top;\r\n    user-select: none;\r\n    width: 1258px;\r\n}\r\n\r\n.cg-component-dialog-text-renderer p {\r\n    display: -webkit-box;\r\n    margin: 0;\r\n    overflow: hidden;\r\n    -webkit-box-orient: vertical;\r\n    -webkit-line-clamp: 6;\r\n}\r\n",""]);const o=h},303:(t,e,i)=>{i.d(e,{Z:()=>o});var r=i(81),s=i.n(r),n=i(645),h=i.n(n)()(s());h.push([t.id,"* {\r\n    margin: 0 0;\r\n    padding: 0 0;\r\n}\r\n\r\nhtml {\r\n    height: 100%;\r\n    width: 100%;\r\n}\r\n\r\nbody {\r\n    background-color: black;\r\n    height: 100%;\r\n    overflow: hidden;\r\n    width: 100%;\r\n}\r\n\r\n.cg-game {\r\n    align-items: center;\r\n    display: flex;\r\n    justify-content: center;\r\n    overflow: hidden;\r\n}\r\n\r\n/* Game custom alert modal window */\r\n.cg-game-alert {\r\n    align-items: center;\r\n    display: flex;\r\n    height: 100%;\r\n    justify-content: center;\r\n    position: absolute;\r\n    width: 100%;\r\n    z-index: 99;\r\n}\r\n\r\n.cg-game-alert-blur {\r\n    backdrop-filter: blur(3px);\r\n    background-color: rgba(37, 37, 37, 0.6);\r\n}\r\n\r\n.cg-game-alert-window {\r\n    height: 50%;\r\n    position: relative;\r\n    width: 50%;\r\n    z-index: 100;\r\n}\r\n\r\n.cg-game-alert-background {\r\n    height: 100%;\r\n    position: absolute;\r\n    width: 100%;\r\n}\r\n\r\n.cg-game-alert-text {\r\n    align-items: center;\r\n    cursor: default;\r\n    display: flex;\r\n    font-size: 3vh;\r\n    height: 60%;\r\n    justify-content: center;\r\n    left: 10%;\r\n    position: relative;\r\n    top: 10%;\r\n    user-select: none;\r\n    width: 80%;\r\n}\r\n\r\n.cg-game-alert-confirm {\r\n    cursor: pointer;\r\n    display: block;\r\n    height: 10%;\r\n    margin: 10% auto;\r\n    position: relative;\r\n}\r\n\r\n.cg-game-alert-confirm:hover {\r\n    opacity: 0.8;\r\n}\r\n\r\n/* Menu */\r\n.menu-modal {\r\n    align-items: center;\r\n    backdrop-filter: blur(3px);\r\n    background-color: rgba(37, 37, 37, 0.8);\r\n    display: flex;\r\n    flex-direction: column;\r\n    height: 100%;\r\n    justify-content: center;\r\n    position: absolute;\r\n    width: 100%;\r\n    z-index: 99;\r\n}\r\n\r\n.menu-option {\r\n    align-items: center;\r\n    background: linear-gradient(70deg, rgb(200, 200, 200), rgb(100, 100, 100), rgb(150, 150, 150));\r\n    border: solid white 1px;\r\n    color: white;\r\n    cursor: default;\r\n    display: flex;\r\n    font-size: 2vh;\r\n    height: 8%;\r\n    justify-content: center;\r\n    margin-bottom: 3%;\r\n    user-select: none;\r\n    width: 20%;\r\n}\r\n\r\n.menu-option:hover {\r\n    background: linear-gradient(70deg, rgba(200, 200, 200, 0.8), rgba(100, 100, 100, 0.8), rgba(150, 150, 150, 0.8));\r\n}\r\n\r\n/* About */\r\n.about-modal {\r\n    align-items: center;\r\n    backdrop-filter: blur(3px);\r\n    background-color: rgba(37, 37, 37, 0.8);\r\n    display: flex;\r\n    height: 100%;\r\n    justify-content: center;\r\n    position: absolute;\r\n    width: 100%;\r\n    z-index: 99;\r\n}\r\n\r\n#about-content {\r\n    background-color: rgb(200, 200, 200);\r\n    box-sizing: border-box;\r\n    cursor: default;\r\n    height: 80%;\r\n    overflow-y: auto;\r\n    padding: 5vh 3vw;\r\n    width: 50%;\r\n}\r\n\r\n#about-content p {\r\n    font-size: 1.5vh;\r\n    margin-bottom: 1vh;\r\n}\r\n\r\n#about-content ul {\r\n    font-size: 1.5vh;\r\n    margin-bottom: 1vh;\r\n    margin-left: 2vh;\r\n}\r\n\r\n#about-content li {\r\n    margin-bottom: 1vh;\r\n}\r\n\r\n#about-content h1 {\r\n    font-size: 3vh;\r\n    line-height: 2;\r\n    text-align: center;\r\n}\r\n\r\n#about-content h2 {\r\n    border-bottom: solid gray 0.5px;\r\n    font-size: 2vh;\r\n    line-height: 1.5;\r\n    margin-bottom: 1vh;\r\n}\r\n\r\n#about-content a {\r\n    color: blue;\r\n    text-decoration: none;\r\n}\r\n\r\n#about-content a:visited {\r\n    color: blue;\r\n}\r\n\r\n#about-close {\r\n    align-items: center;\r\n    background-color: lightgray;\r\n    border: solid white 1px;\r\n    border-radius: 0.5vh;\r\n    cursor: default;\r\n    display: flex;\r\n    justify-content: center;\r\n    margin: auto;\r\n    margin-top: 2vh;\r\n    padding: 1vh 0;\r\n    user-select: none;\r\n    width: 10%;\r\n}\r\n\r\n#about-close:hover {\r\n    background-color: gray;\r\n}\r\n",""]);const o=h},734:(t,e,i)=>{i.d(e,{Z:()=>o});var r=i(81),s=i.n(r),n=i(645),h=i.n(n)()(s());h.push([t.id,"body {\r\n    height: 100vh;\r\n    width: 100vw;\r\n}\r\n\r\n.progress-wrapper {\r\n    background-color: black;\r\n    height: 100%;\r\n    position: absolute;\r\n    top: 0;\r\n    width: 100%;\r\n}\r\n\r\n.progress-text {\r\n    animation: blink 2s infinite ease-in-out;\r\n    box-sizing: border-box;\r\n    color: white;\r\n    font-size: 2vh;\r\n    padding-right: 10%;\r\n    position: absolute;\r\n    text-align: right;\r\n    top: 90%;\r\n    width: 100%;\r\n}\r\n\r\n@keyframes blink {\r\n    0% {\r\n        opacity: 1;\r\n    }\r\n\r\n    100% {\r\n        opacity: 0;\r\n    }\r\n}\r\n",""]);const o=h},974:(t,e,i)=>{i.d(e,{Z:()=>o});var r=i(81),s=i.n(r),n=i(645),h=i.n(n)()(s());h.push([t.id,"/* Wrapper of the renderer canvases */\r\n.cg-renderer-wrapper {\r\n    position: relative;\r\n}\r\n\r\n/* Renderer canvases */\r\n.cg-renderer-canvas {\r\n    height: 100%;\r\n    position: absolute;\r\n    width: 100%;\r\n}\r\n",""]);const o=h},645:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i="",r=void 0!==e[5];return e[4]&&(i+="@supports (".concat(e[4],") {")),e[2]&&(i+="@media ".concat(e[2]," {")),r&&(i+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),i+=t(e),r&&(i+="}"),e[2]&&(i+="}"),e[4]&&(i+="}"),i})).join("")},e.i=function(t,i,r,s,n){"string"==typeof t&&(t=[[null,t,void 0]]);var h={};if(r)for(var o=0;o<this.length;o++){var a=this[o][0];null!=a&&(h[a]=!0)}for(var l=0;l<t.length;l++){var c=[].concat(t[l]);r&&h[c[0]]||(void 0!==n&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=n),i&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=i):c[2]=i),s&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=s):c[4]="".concat(s)),e.push(c))}},e}},81:t=>{t.exports=function(t){return t[1]}},379:t=>{var e=[];function i(t){for(var i=-1,r=0;r<e.length;r++)if(e[r].identifier===t){i=r;break}return i}function r(t,r){for(var n={},h=[],o=0;o<t.length;o++){var a=t[o],l=r.base?a[0]+r.base:a[0],c=n[l]||0,d="".concat(l," ").concat(c);n[l]=c+1;var u=i(d),g={css:a[1],media:a[2],sourceMap:a[3],supports:a[4],layer:a[5]};if(-1!==u)e[u].references++,e[u].updater(g);else{var _=s(g,r);r.byIndex=o,e.splice(o,0,{identifier:d,updater:_,references:1})}h.push(d)}return h}function s(t,e){var i=e.domAPI(e);return i.update(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;i.update(t=e)}else i.remove()}}t.exports=function(t,s){var n=r(t=t||[],s=s||{});return function(t){t=t||[];for(var h=0;h<n.length;h++){var o=i(n[h]);e[o].references--}for(var a=r(t,s),l=0;l<n.length;l++){var c=i(n[l]);0===e[c].references&&(e[c].updater(),e.splice(c,1))}n=a}}},569:t=>{var e={};t.exports=function(t,i){var r=function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}e[t]=i}return e[t]}(t);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(i)}},216:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},565:(t,e,i)=>{t.exports=function(t){var e=i.nc;e&&t.setAttribute("nonce",e)}},795:t=>{t.exports=function(t){var e=t.insertStyleElement(t);return{update:function(i){!function(t,e,i){var r="";i.supports&&(r+="@supports (".concat(i.supports,") {")),i.media&&(r+="@media ".concat(i.media," {"));var s=void 0!==i.layer;s&&(r+="@layer".concat(i.layer.length>0?" ".concat(i.layer):""," {")),r+=i.css,s&&(r+="}"),i.media&&(r+="}"),i.supports&&(r+="}");var n=i.sourceMap;n&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),e.styleTagTransform(r,t,e.options)}(e,t,i)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},589:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},e={};function i(r){var s=e[r];if(void 0!==s)return s.exports;var n=e[r]={id:r,exports:{}};return t[r](n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;i.g.importScripts&&(t=i.g.location+"");var e=i.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var r=e.getElementsByTagName("script");r.length&&(t=r[r.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})(),i.nc=void 0,(()=>{class t{constructor(t,e){this.x=t,this.y=e}inside(t){return this.x>=t.x&&this.x<=t.x+t.width&&this.y>=t.y&&this.y<=t.y+t.height}copy(){return new t(this.x,this.y)}add(t){return"number"==typeof t?(this.x+=t,this.y+=t):(this.x+=t.x,this.y+=t.y),this}minus(t){return"number"==typeof t?(this.x-=t,this.y-=t):(this.x-=t.x,this.y-=t.y),this}multiply(t){return"number"==typeof t?(this.x*=t,this.y*=t):(this.x*=t.x,this.y*=t.y),this}divide(t){return"number"==typeof t?(this.x/=t,this.y/=t):(this.x/=t.x,this.y/=t.y),this}}class e{constructor(t,e,i,r,s=1){this.scale=s,this.x=t*this.scale,this.y=e*this.scale,this.width=i*this.scale,this.height=r*this.scale}copy(){return new e(this.x,this.y,this.width,this.height)}spread(){return[this.x,this.y,this.width,this.height]}}class r{constructor(){this.prevent_freeze=!1}destroy(){}}class s extends r{constructor(t,e,i,r){super(),this.text=t,this.rect=e,this.color=i,this.font_size=r}static from(t){return i=this,r=void 0,h=function*(){return t[1]=new e(...t[1]),()=>new s(...t)},new((n=void 0)||(n=Promise))((function(t,e){function s(t){try{a(h.next(t))}catch(t){e(t)}}function o(t){try{a(h.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(s,o)}a((h=h.apply(i,r||[])).next())}));var i,r,n,h}draw(t,e,i){let r=t.getContext("2d");r.save(),r.fillStyle=this.color,r.font=`bold ${this.font_size}px "Microsoft Yahei"`,r.textBaseline="middle",r.textAlign="center",r.fillText(this.text,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2,this.rect.width),r.restore()}}var n=i(379),h=i.n(n),o=i(795),a=i.n(o),l=i(569),c=i.n(l),d=i(565),u=i.n(d),g=i(216),_=i.n(g),p=i(589),f=i.n(p),m=i(734),w={};w.styleTagTransform=f(),w.setAttributes=u(),w.insert=c().bind(null,"head"),w.domAPI=a(),w.insertStyleElement=_(),h()(m.Z,w),m.Z&&m.Z.locals&&m.Z.locals;let v=new Map;function b(t){return new Promise(((e,i)=>{if(v.has(t))e(v.get(t));else{let r=new Image;void 0!==window.static_url&&"/"==t[0]?r.src=`${window.static_url}${t}`:r.src=t,r.crossOrigin="Anonymous",r.onload=function(){v.set(t,r),e(r)},r.onerror=i}}))}class y{constructor(e=-1,i=new t(NaN,NaN),r=""){this.button=e,this.position=i,this.key=r}}class x{constructor(t=document.body){this.parent=t;let e=document.createElement("div");e.className="progress-wrapper",t.appendChild(e);let i=document.createElement("p");i.innerHTML="加载中……",i.className="progress-text",e.appendChild(i)}}class k extends r{constructor(t,e,i,r=null,s="#ffffff",n="#000000"){super(),this.text=t,this.rect=e,this.font_size=i,this.bg_image=r,this.bg_color=s,this.fg_color=n,this.last_draw_button_state=-1,this.button_held=!1,this.curved=!0,this.prevent_freeze=!0,this.onclick=()=>{},this.rect=this.rect.copy()}draw_curved_border(t){let e=Math.min(this.rect.width,this.rect.height)/10;t.beginPath(),t.moveTo(this.rect.x+e,this.rect.y),t.lineTo(this.rect.x+this.rect.width-e,this.rect.y),t.arcTo(this.rect.x+this.rect.width,this.rect.y,this.rect.x+this.rect.width,this.rect.y+e,e),t.lineTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height-e),t.arcTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height,this.rect.x+this.rect.width-e,this.rect.y+this.rect.height,e),t.lineTo(this.rect.x+e,this.rect.y+this.rect.height),t.arcTo(this.rect.x,this.rect.y+this.rect.height,this.rect.x,this.rect.y+this.rect.height-e,e),t.lineTo(this.rect.x,this.rect.y+e),t.arcTo(this.rect.x,this.rect.y,this.rect.x+e,this.rect.y,e)}draw_border(t){t.beginPath(),t.moveTo(this.rect.x,this.rect.y),t.lineTo(this.rect.x+this.rect.width,this.rect.y),t.lineTo(this.rect.x+this.rect.width,this.rect.y+this.rect.height),t.lineTo(this.rect.x,this.rect.y+this.rect.height),t.lineTo(this.rect.x,this.rect.y)}draw_foreground(t){t.font=`${this.font_size}px "Microsoft YaHei"`,t.textBaseline="middle",t.textAlign="center",t.fillStyle=this.fg_color,t.fillText(this.text,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2,this.rect.width)}draw(t,e,i){let r=t.getContext("2d"),s=i.position.inside(this.rect);-1==this.last_draw_button_state&&0==i.button&&s?this.button_held=!0:-1==i.button&&(this.button_held&&s&&this.onclick(),this.button_held=!1),r.save(),s&&0!=i.button||this.button_held?r.globalAlpha=.6:r.globalAlpha=1,this.curved?this.draw_curved_border(r):this.draw_border(r),null==this.bg_image?(r.fillStyle=this.bg_color,r.fill()):(r.clip(),r.drawImage(this.bg_image,this.rect.x,this.rect.y,this.rect.width,this.rect.height)),this.draw_foreground(r),r.restore(),this.last_draw_button_state=i.button}}class E extends k{constructor(t,i,r=null,s=!0){if(super("",t,0,i),this.fg_image=r,this.selected=!1,this.onclick=()=>{this.selected=!this.selected},this.curved=s,null!=this.fg_image){let t,i,r=.6,s=this.fg_image.width/this.fg_image.height;s>=this.rect.width/this.rect.height?(t=this.rect.width*r,i=t/s):(i=this.rect.height*r,t=i*s),this.foreground_rect=new e(this.rect.x+this.rect.width/2-t/2,this.rect.y+this.rect.height/2-i/2,t,i)}}static from(t){return i=this,r=void 0,n=function*(){return t[0]=new e(...t[0]),t[1]=yield b(t[1]),t.length>=3&&(""==t[2]?t[2]=null:t[2]=yield b(t[2])),()=>new E(...t)},new((s=void 0)||(s=Promise))((function(t,e){function h(t){try{a(n.next(t))}catch(t){e(t)}}function o(t){try{a(n.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(i,r||[])).next())}));var i,r,s,n}draw_foreground(t){t.save(),t.globalAlpha=1,null!=this.fg_image&&t.drawImage(this.fg_image,this.foreground_rect.x,this.foreground_rect.y,this.foreground_rect.width,this.foreground_rect.height),this.selected&&(t.globalAlpha=.4,t.fillStyle="#000000",this.curved?this.draw_curved_border(t):this.draw_border(t),t.fill()),t.restore()}draw(t,e,i){super.draw(t,e,i)}}class L extends r{constructor(t){super(),this.children=t,this.prevent_freeze=!0,this.selected=-1;let e=0;for(let t of this.children){let i=e;t.onclick=()=>{if(t.selected)t.selected=!1,this.selected=-1;else{t.selected=!0,this.selected=i;for(let t=0;t<this.children.length;t++)t!=i&&(this.children[t].selected=!1)}},e++}}static from(t){return e=this,i=void 0,s=function*(){let e=[];for(let i of t)i=i.slice(),i.push(""),i.push(!1),e.push(yield E.from(i));return()=>new L(e.map((function(t){return t()})))},new((r=void 0)||(r=Promise))((function(t,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function o(t){try{a(s.throw(t))}catch(t){n(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(h,o)}a((s=s.apply(e,i||[])).next())}));var e,i,r,s}draw(t,e,i){for(let r of this.children)r.draw(t,e,i)}}class M extends r{constructor(t,e="#ffffff"){super(),this.rect=t,this.color=e,this.rect=this.rect.copy()}draw(t,e,i){let r=t.getContext("2d");r.save(),r.fillStyle=this.color,r.fillRect(...this.rect.spread()),r.restore()}}var T=i(655),z={};z.styleTagTransform=f(),z.setAttributes=u(),z.insert=c().bind(null,"head"),z.domAPI=a(),z.insertStyleElement=_(),h()(T.Z,z),T.Z&&T.Z.locals&&T.Z.locals;const $=i.p+"5ffd5abb4314a1190ee6.png";class C extends r{constructor(t,i=""){super(),this.rect=t,this.content=i,this.text_element=document.createElement("div"),this.aspect_ratio=1.466,this.text_element.innerHTML=`<p>${this.content}</p>`,this.text_element.classList.add("cg-component-dialog-text-renderer"),this.rect.height<0||this.rect.width>0&&this.rect.height>0?this.rect.height=this.rect.width/this.aspect_ratio:this.rect.width=this.rect.height*this.aspect_ratio,this.rect=this.rect.copy(),this.text_rect=new e(this.rect.x+this.rect.width*(3.57/12.41),this.rect.y+this.rect.height*(1.79/8.47),this.rect.width*(6.29/12.41),this.rect.height*(2.58/8.47))}static from(t){return i=this,r=void 0,n=function*(){return t[0]=new e(...t[0]),()=>new C(t[0],t[1])},new((s=void 0)||(s=Promise))((function(t,e){function h(t){try{a(n.next(t))}catch(t){e(t)}}function o(t){try{a(n.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(i,r||[])).next())}));var i,r,s,n}static load(){b($).then((t=>{C.dialog_text_box=t}))}draw(t,e,i){if(null==C.dialog_text_box)return void C.load();t.getContext("2d").drawImage(C.dialog_text_box,...this.rect.spread());let r=Number(getComputedStyle(t).width.replace("px",""))/t.width;this.text_element.style.left=this.text_rect.x*r+"px",this.text_element.style.top=this.text_rect.y*r+"px",this.text_element.style.transform=`scale(${this.text_rect.width*r/1258})`,t.parentElement.appendChild(this.text_element)}destroy(){this.text_element.remove()}}C.dialog_text_box=null,C.load();class A extends r{constructor(t,e=null,i=!1){super(),this.image=t,this.rect=e,this.rect=this.rect.copy(),this.prevent_freeze=i}static from(t){return i=this,r=void 0,n=function*(){return t[0]=yield b(t[0]),t[1]=new e(...t[1]),()=>new A(...t)},new((s=void 0)||(s=Promise))((function(t,e){function h(t){try{a(n.next(t))}catch(t){e(t)}}function o(t){try{a(n.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(i,r||[])).next())}));var i,r,s,n}draw(t,e,i){let r=t.getContext("2d");null!=this.rect?r.drawImage(this.image,this.rect.x,this.rect.y,this.rect.width,this.rect.height):r.drawImage(this.image,0,0,this.image.naturalWidth,this.image.naturalHeight)}}class S extends A{constructor(t,e,i=!1){super(t,e),this.flash=i,this.flash_curve=(1,.2,.2,1,function(t){return 1*Math.pow(t,3)+3*.2*Math.pow(t,2)*(1-t)+3*.2*t*Math.pow(1-t,2)+1*Math.pow(1-t,3)}),this.period=2e3,this.start_time=-1,this.last_draw_button_state=-1,this.button_held=!1,this.onclick=()=>{},this.prevent_freeze=!0,this.rect=this.rect.copy()}draw(t,e,i){let r=t.getContext("2d"),s=i.position.inside(this.rect);if(-1==this.last_draw_button_state&&0==i.button&&s?this.button_held=!0:-1==i.button&&(this.button_held&&s&&this.onclick(),this.button_held=!1),-1==this.start_time&&(this.start_time=performance.now()),r.save(),this.flash){let t=(performance.now()-this.start_time)%this.period/this.period;r.globalAlpha=this.flash_curve(t)}super.draw(t,e,i),r.restore()}}class j extends r{constructor(t,e){super(),this.content=t,this.rect=e,this.disable_scroll=!1,this.scroll_bar_width=this.rect.width/100,this.is_scrolling=!1,this.last_draw_button_status=-1,this.button_down_position=null,this.button_down_progress=null,this.mouse_wheel_scroll=0,this.mouse_wheel_callback=t=>{this.mouse_wheel_scroll=t.deltaY},this.has_reached_bottom=!1,this.prevent_freeze=!0,this.rect=this.rect.copy(),this.scale_factor=e.width/t.width,this.min_progress=Math.min(e.height/(t.height*this.scale_factor),1),this.progress=this.min_progress,this.disable_scroll=e.height>=t.height*this.scale_factor,this.disable_scroll&&(this.prevent_freeze=!1,this.has_reached_bottom=!0),window.addEventListener("wheel",this.mouse_wheel_callback)}get_scroll_thumb_rect(t=this.progress){return t=Math.min(Math.max(t,this.min_progress),1),new e(this.rect.x+this.rect.width,this.rect.y+this.rect.height*(this.progress-this.min_progress),this.scroll_bar_width,this.rect.height*this.min_progress)}draw(t,i,r){let s=t.getContext("2d");if(s.save(),s.beginPath(),s.rect(...this.rect.spread()),s.clip(),s.drawImage(this.content,this.rect.x,this.rect.y-this.content.height*this.scale_factor*(this.progress-this.min_progress),this.rect.width,this.content.height*this.scale_factor),s.restore(),!this.disable_scroll){let t=this.progress;0==this.mouse_wheel_scroll&&0==r.button?-1==this.last_draw_button_status&&(r.position.inside(this.get_scroll_thumb_rect())?(this.is_scrolling=!0,this.button_down_position=r.position.y,this.button_down_progress=this.progress):r.position.inside(new e(this.rect.x+this.rect.width,this.rect.y,this.scroll_bar_width,this.rect.height))&&(this.is_scrolling=!1,t=(r.position.y-this.rect.y)/this.rect.height+this.min_progress,this.progress=Math.min(Math.max(t,this.min_progress),1))):this.is_scrolling=!1,this.is_scrolling?(t=(r.position.y-this.button_down_position)/this.rect.height+this.button_down_progress,this.progress=Math.min(Math.max(t,this.min_progress),1)):0!=this.mouse_wheel_scroll&&(t+=this.mouse_wheel_scroll/(this.content.height*(document.documentElement.clientWidth/this.content.width)),this.progress=Math.min(Math.max(t,this.min_progress),1),this.mouse_wheel_scroll=0),s.save(),s.fillStyle="#F1F1F1",s.fillRect(this.rect.x+this.rect.width,this.rect.y,this.scroll_bar_width,this.rect.height),s.fillStyle=this.is_scrolling?"#787878":"#A8A8A8",s.fillRect(this.rect.x+this.rect.width,this.rect.y+this.rect.height*(this.progress-this.min_progress),this.scroll_bar_width,this.rect.height*this.min_progress),s.restore(),this.last_draw_button_status=r.button,this.progress>=.95&&(this.has_reached_bottom=!0)}}destroy(){window.removeEventListener("wheel",this.mouse_wheel_callback)}}class N extends r{constructor(t,e){super(),this.initial_time=t,this.rect=e,this.start_time=-1,this.prevent_freeze=!0,this.rect=this.rect.copy(),this.initial_time=Math.max(Math.min(this.initial_time,3599),0),this.rect.width<0?this.rect.width=this.rect.height*N.aspect_ratio:this.rect.height=this.rect.width/N.aspect_ratio,this.time=this.initial_time}get finished(){return 0==this.time}draw(t,e,i){let r=t.getContext("2d");-1==this.start_time&&(this.start_time=performance.now()),this.time=Math.max(Math.round(this.initial_time-(performance.now()-this.start_time)/1e3),0);let s=Math.floor(this.time/60),n=this.time-60*s,h=`${`0${s}`.slice(-2)} : ${`0${n}`.slice(-2)}`;r.save(),r.fillStyle="#252525",r.globalAlpha=.6,r.fillRect(...this.rect.spread()),r.textAlign="center",r.textBaseline="middle",r.font=`bold ${this.rect.height/2}px "Microsoft Yahei"`,r.fillStyle="#A52A2A",r.globalAlpha=1,r.fillText(h,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2),r.restore()}}N.aspect_ratio=3;var I=i(974),P={};P.styleTagTransform=f(),P.setAttributes=u(),P.insert=c().bind(null,"head"),P.domAPI=a(),P.insertStyleElement=_(),h()(I.Z,P),I.Z&&I.Z.locals&&I.Z.locals;class q{constructor(e,i,r,s=1){this.width=i,this.height=r,this.ratio=s,this.frozen_content=null,this.draw_call_list=[],this.backup_draw_call_list=[],this.event=new y,this.cursor_is_set=!1,this.should_redraw=!1,this.force_freeze=!1,this.button_down_event_listener=t=>{-1==this.event.button&&(this.event.button=t.button)},this.button_move_event_listener=e=>{let i=this.front_buffer_canvas.getBoundingClientRect();this.event.position=new t(e.clientX-i.x,e.clientY-i.y).divide(this.ratio)},this.button_up_event_listener=t=>{t.button==this.event.button&&(this.event.button=-1)},this.key_down_listener=t=>{""==this.event.key&&(this.event.key=t.key)},this.key_up_listener=t=>{t.key==this.event.key&&(this.event.key="")},this.animationFrameRequestId=null,e.innerHTML="",this.parent=document.createElement("div"),this.parent.className="cg-renderer-wrapper",this.parent.style.width=i*s+"px",this.parent.style.height=r*s+"px",e.appendChild(this.parent),this.back_buffer_canvas=this.create_canvas(),this.back_buffer=this.back_buffer_canvas.getContext("2d",{willReadFrequently:!0}),this.front_buffer_canvas=this.create_canvas(),this.front_buffer=this.front_buffer_canvas.getContext("2d"),document.addEventListener("keydown",this.key_down_listener),document.addEventListener("keyup",this.key_up_listener),this.front_buffer_canvas.addEventListener("mousedown",this.button_down_event_listener),this.front_buffer_canvas.addEventListener("mouseup",this.button_up_event_listener),document.addEventListener("mouseup",this.button_up_event_listener),document.addEventListener("mousemove",this.button_move_event_listener),X.on("set-cursor",(t=>{this.cursor_is_set||(this.front_buffer_canvas.style.cursor=t,"pointer"==t&&(this.cursor_is_set=!0))})),window.addEventListener("contextmenu",(t=>{t.preventDefault()}))}create_canvas(){let t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.classList.add("cg-renderer-canvas"),this.parent.appendChild(t),t}clear_buffer(t){t.clearRect(0,0,this.width,this.height)}frame(){let i;if(this.cursor_is_set=!1,this.clear_buffer(this.back_buffer),i=this.force_freeze?{button:-1,position:new t(-1,-1),key:""}:this.event,this.should_redraw){for(let t of this.draw_call_list)t.freeze&&t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),i);this.frozen_content=this.back_buffer.getImageData(0,0,this.width,this.height),this.clear_buffer(this.back_buffer),this.should_redraw=!1}null!=this.frozen_content&&this.back_buffer.putImageData(this.frozen_content,0,0);for(let t of this.draw_call_list)t.freeze||t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),i);this.clear_buffer(this.front_buffer),this.front_buffer.drawImage(this.back_buffer_canvas,0,0),this.animationFrameRequestId=window.requestAnimationFrame(this.frame.bind(this))}setHeight(t){this.ratio=t/this.height,this.parent.style.width=t/this.height*this.width+"px",this.parent.style.height=`${t}px`,this.should_redraw=!0}addEventListener(t,e,i=null){this.front_buffer_canvas.addEventListener(t,e,i)}removeEventListener(t,e,i=null){this.front_buffer_canvas.removeEventListener(t,e,i)}draw(t,e=!0){t.prevent_freeze&&(e=!1),this.backup_draw_call_list.push({component:t,freeze:e})}render(t=!1){this.force_freeze=t,this.clear(),this.draw_call_list=this.backup_draw_call_list,this.backup_draw_call_list=[];for(let t of this.draw_call_list)t.freeze&&t.component.draw(this.back_buffer_canvas,new e(0,0,this.width,this.height),this.event);this.frozen_content=this.back_buffer.getImageData(0,0,this.width,this.height),this.clear_buffer(this.back_buffer),this.frame()}clear(){null!=this.animationFrameRequestId&&(window.cancelAnimationFrame(this.animationFrameRequestId),this.animationFrameRequestId=null);for(let t of this.draw_call_list)t.component.destroy();this.clear_buffer(this.back_buffer),this.clear_buffer(this.front_buffer),this.draw_call_list=[],this.frozen_content=null}destroy(){document.removeEventListener("keydown",this.key_down_listener),document.removeEventListener("keyup",this.key_up_listener),this.front_buffer_canvas.removeEventListener("mousedown",this.button_down_event_listener),this.front_buffer_canvas.removeEventListener("mouseup",this.button_up_event_listener),document.removeEventListener("mouseup",this.button_up_event_listener),document.removeEventListener("mousemove",this.button_move_event_listener),this.parent.remove()}}var Z=i(303),R={};R.styleTagTransform=f(),R.setAttributes=u(),R.insert=c().bind(null,"head"),R.domAPI=a(),R.insertStyleElement=_(),h()(Z.Z,R),Z.Z&&Z.Z.locals&&Z.Z.locals;const H=i.p+"8c54d1d41902b0d9aece.png",F=i.p+"07affb794335470e2f64.png",O=i.p+"f2e50899fcdfb12dcec4.jpg",W=i.p+"67ea60c3639a4f248416.png",B=i.p+"ee6237f24b09b656f81e.png",D=i.p+"55f491b078881f8488aa.png";class Y extends A{constructor(t,e,i=!1,r=null,s=!1,n=!0){super(t,e),this.restore_position_upon_loose=i,this.target_area=r,this.absorb=s,this.show_target_area=n,this.is_moving=!1,this.last_draw_button_status=-1,this.prevent_freeze=!0,this.whereabout=-1,this.default_rect=e.copy()}static from(t){return i=this,r=void 0,n=function*(){if(t[0]=yield b(t[0]),t[1]=new e(...t[1]),t.length>=4){let i=[];for(let r of t[3])i.push(new e(...r));t[3]=i}return()=>new Y(...t)},new((s=void 0)||(s=Promise))((function(t,e){function h(t){try{a(n.next(t))}catch(t){e(t)}}function o(t){try{a(n.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}a((n=n.apply(i,r||[])).next())}));var i,r,s,n}draw(t,e,i){Y.registered_list.has(this)||Y.registered_list.set(this,!1);let r=!0;if(!this.is_moving){let t=Array.from(Y.registered_list.keys());for(let e=t.indexOf(this)+1;e<t.length;e++)if(i.position.inside(t[e].rect)){r=!1;break}}let s=this.is_moving;r&&(0==i.button&&(-1==this.last_draw_button_status&&i.position.inside(this.rect)||this.is_moving)?this.is_moving=!0:this.is_moving=!1),this.last_draw_button_status=i.button;let n=e=>{if(this.show_target_area){let i=t.getContext("2d"),r=i.fillStyle;i.fillStyle="#cce099",i.fillRect(e.x,e.y,e.width,e.height),i.fillStyle=r}return!0};if(this.is_moving){let t=i.position.x-this.rect.width/2,r=i.position.y-this.rect.height/2;if(this.rect.x=Math.min(Math.max(0,t),e.width-this.rect.width),this.rect.y=Math.min(Math.max(0,r),e.height-this.rect.height),Array.isArray(this.target_area))for(let t of this.target_area)n(t);else null!=this.target_area&&n(this.target_area)}else if(s)if(this.absorb){let t=!1;if(Array.isArray(this.target_area)){let e=0;for(let r of this.target_area){if(i.position.inside(r)){this.rect.x=r.x+r.width/2-this.rect.width/2,this.rect.y=r.y+r.height/2-this.rect.height/2,t=!0,this.whereabout=e;break}e++}}else null!=this.target_area&&i.position.inside(this.target_area)&&(this.rect.x=this.target_area.x+this.target_area.width/2-this.rect.width/2,this.rect.y=this.target_area.y+this.target_area.height/2-this.rect.height/2,t=!0,this.whereabout=0);t||(this.restore_position_upon_loose&&this.restore_default_position(),this.whereabout=-1)}else if(this.restore_position_upon_loose)this.restore_default_position();else if(Array.isArray(this.target_area)){let t=0;for(let e of this.target_area){if(i.position.inside(e)){this.whereabout=t;break}t++}}else null!=this.target_area&&i.position.inside(this.target_area)&&(this.whereabout=0);super.draw(t,e,i)}restore_default_position(){this.rect=this.default_rect.copy()}destroy(){Y.registered_list.delete(this)}}Y.registered_list=new Map;var J,U=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function h(t){try{a(r.next(t))}catch(t){n(t)}}function o(t){try{a(r.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}a((r=r.apply(t,e||[])).next())}))};class X{constructor(t,e=document.body){let i;this.course=t,this.parent=e,this.is_alert=!1,this.is_picking_session=!1,this.is_showing_menu=!1,this.alert_modal=null,this.game_progress=window.progress,this.csrf_token=document.getElementsByName("csrfmiddlewaretoken")[0].value,this.global_callbacks=new Map,this.resize_callback=()=>{document.documentElement.clientWidth/document.documentElement.clientHeight>this.width/this.height?this.renderer.setHeight(document.documentElement.clientHeight):this.renderer.setHeight(document.documentElement.clientWidth/this.width*this.height)},this.keyup_callback=t=>{"Escape"==t.key&&this.menu()},this.width=3200,this.height=1800,this.game_content=new Array(this.course.sessions.length),this.about_text="",this.parent.classList.add("cg-game"),i=document.documentElement.clientWidth/document.documentElement.clientHeight>this.width/this.height?document.documentElement.clientHeight/this.height:document.documentElement.clientWidth/this.width,this.renderer=new q(this.parent,this.width,this.height,i),window.addEventListener("resize",this.resize_callback),document.addEventListener("keyup",this.keyup_callback)}static message(t,e=null){this.event_list.push({event:t,param:e})}static on(t,e){this.event_listeners.has(t)?(this.event_listeners.set(t,e),console.warn(`Event ${t} has already been registered and is now replaced by another by the same name`)):this.event_listeners.set(t,e)}static parse_component(t){return U(this,void 0,void 0,(function*(){let e,i=t.params.slice();switch(t.name.toLowerCase()){case"dialog":e=yield C.from(i);break;case"drag":e=yield Y.from(i);break;case"img":e=yield A.from(i);break;case"select":e=yield E.from(i);break;case"single-select":e=yield L.from(i);break;case"text":e=yield s.from(i)}return e}))}static parse_scene(t){return U(this,void 0,void 0,(function*(){let e={};e.question=t.question;let i=[];for(let e of t.layout)i.push(yield this.parse_component(e));return e.layout=()=>{let t=[];for(let e of i)t.push(e());return t},e.correct_func=t.correct_func,e}))}static parse_level(t){return U(this,void 0,void 0,(function*(){let i={};i.position=new e(...t.position),i.paper=yield b(t.paper),i.prompt=t.prompt,i.correct=t.correct.slice(),i.objects=[];for(let e of t.objects)i.objects.push(yield b(e));i.scenes=[];for(let e of t.scenes)i.scenes.push(yield this.parse_scene(e));return i}))}static parse_session(t){return U(this,void 0,void 0,(function*(){let e={};e.map=yield b(t.map),e.background=yield b(t.background),e.marker=yield b(t.marker),e.levels=[];for(let i of t.levels)e.levels.push(yield this.parse_level(i));return e}))}static parse_course(t){return U(this,void 0,void 0,(function*(){let e={};return e.map=yield b(t.map),e.finished_marker=yield b(t.finished_marker),e.unfinished_marker=yield b(t.unfinished_marker),e}))}validate_progress(t,e){return this.game_progress.session>t||this.game_progress.session==t&&this.game_progress.level>=e}update_progress(t){return U(this,void 0,void 0,(function*(){return new Promise((e=>{this.game_progress=t,fetch(window.location.href,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrf_token},body:JSON.stringify(this.game_progress),credentials:"same-origin"}).then((t=>t.text())).then((t=>{e(Number(t))}))}))}))}pick_session(){this.is_picking_session=!0,this.renderer.removeEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.draw(new A(this.course.map,new e(0,0,this.width,this.height)));for(let t=0;t<this.course.sessions.length;t++){let e;if(t<this.game_progress.session)e=new S(this.course.finished_marker,this.course.sessions[t].position);else{if(t!=this.game_progress.session)continue;e=new S(this.course.unfinished_marker,this.course.sessions[t].position)}e.onclick=()=>U(this,void 0,void 0,(function*(){if(void 0===this.game_content[t]){let e=yield X.parse_session(this.course.sessions[t].get);this.game_content[t]=e,this.pick_level(t)}else this.pick_level(t)})),this.renderer.draw(e)}this.renderer.render()}pick_level(t){this.is_picking_session=!1;let i=this.game_progress;if(t>i.session)return void console.error(`current session: ${t}\nprogress session: ${i.session}`);let r,s=this.game_content[t];this.renderer.draw(new A(s.map,new e(0,0,this.width,this.height))),r=i.session>t?s.levels.length:i.level;for(let e=0;e<r;e++){let i=new S(s.marker,s.levels[e].position);i.onclick=()=>{this.read_paper(t,e)},this.renderer.draw(i)}if(r!=s.levels.length){let e=new S(s.marker,s.levels[r].position,!0);e.onclick=()=>{this.read_paper(t,r)},this.renderer.draw(e)}this.renderer.render()}read_paper(t,i,r=null){this.is_picking_session=!1;let s=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${s.session}, level: ${s.level}`);let n=this.game_content[t],h=n.levels[i];this.renderer.draw(new A(n.background,new e(0,0,this.width,this.height)));let o,a=new j(h.paper,new e(this.width/16,this.height/6,7*this.width/8,2*this.height/3));this.renderer.draw(a),o=null==r?s.session>t||s.level>i?20:60:r;let l=new N(o,new e(this.width/2-this.height/9*N.aspect_ratio/2,this.height/36,this.height/9*N.aspect_ratio,this.height/9));this.renderer.draw(l);let c=new k("",new e(this.width/2-this.height/18*(this.button_background.width/this.button_background.height),this.height-this.height/36-this.height/9,this.height/9*(this.button_background.width/this.button_background.height),this.height/9),this.height/18,this.button_background,"#000000","#351500");c.onclick=()=>{a.has_reached_bottom?l.finished?this.prompt_object_selection(t,i):this.alert(`你需要至少阅读${o}秒才能继续游戏~`):this.alert("你需要看完文献的全部内容才能继续游戏~")},this.renderer.draw(c),this.renderer.render()}prompt_object_selection(t,i){this.is_picking_session=!1;let r=this.game_progress;this.validate_progress(t,i)?(this.renderer.draw(new A(this.object_select_background,new e(0,0,this.width,this.height))),this.renderer.draw(new A(this.speaker,new e(this.height/6,this.height/3,this.height/3,this.height/3))),this.alert(this.game_content[t].levels[i].prompt,(()=>{this.select_object(t,i)}),!1),this.renderer.render()):console.error(`requested session: ${t}, level: ${i}\nprogress session: ${r.session}, level: ${r.level}`)}select_object(t,i){this.is_picking_session=!1;let r=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${r.session}, level: ${r.level}`);let s=this.game_content[t].levels[i].objects,n=this.game_content[t].levels[i].correct;this.renderer.draw(new A(this.object_select_background,new e(0,0,this.width,this.height)));let h=[],o=this.height*(2/3)/32,a=this.height*(2/3)/3.2;for(let t=0;t<9;t++){let i=Math.floor(t/3),r=t%3;h[t]=new E(new e(this.width/2-this.height/3+a*r+o*r,this.height/6+a*i+o*i,a,a),this.object_select_grid,s[t]),this.renderer.draw(h[t])}let l=new k("",new e(this.width/2-this.height/18*(this.button_background.width/this.button_background.height),this.height-this.height/36-this.height/9,this.height/9*(this.button_background.width/this.button_background.height),this.height/9),this.height/18,this.button_background,"#000000","#351500");l.onclick=()=>{let e=!0;for(let t=0;t<9;t++){let i=h[t];if(i.selected&&-1==n.indexOf(t)||!i.selected&&-1!=n.indexOf(t)){e=!1;break}}if(e){let e;e=r.session>t||r.level>i?0:r.scene,this.play_scene(t,i,e)}else this.alert("选择错误，请重新选择~",(()=>{this.prompt_object_selection(t,i)}))},this.renderer.draw(l),this.renderer.render()}play_scene(t,i,r){this.is_picking_session=!1;let n=this.game_progress;if(!this.validate_progress(t,i))return void console.error(`requested session: ${t}, level: ${i}\nprogress session: ${n.session}, level: ${n.level}`);r=Math.floor(r);let h=this.game_content[t],o=h.levels[i],a=o.scenes[r],l=n.session>t||n.level>i,c=!l&&-1==n.scene.toString().indexOf(".5");this.renderer.draw(new A(h.background,new e(0,0,this.width,this.height))),this.renderer.draw(new A(this.play_bar,new e(.125*this.width,.015*this.height,.75*this.width,.125*this.height))),this.renderer.draw(new M(new e(.125*this.width,.15*this.height,.75*this.width,.7*this.height))),this.renderer.draw(new s(`关卡${Math.floor(i)+1}（共${h.levels.length}关）: ${Math.floor(r)+1} / ${o.scenes.length}`,new e(.625*this.width,.015*this.height,.25*this.width,.125*this.height),"#000000",.03*this.height));let d=a.layout();for(let t of d)this.renderer.draw(t);this.renderer.draw(new A(this.speaker,new e(0,this.height-this.height/3,this.height/3,this.height/3)));let u,g=new C(new e(this.height/4,this.height-this.height/3-.23*this.height,-1,this.height/3),a.question);g.prevent_freeze=!0,this.renderer.draw(g),l||(u=new N(c?10:5,new e(.14*this.width,.045*this.height,-1,.065*this.height)),this.renderer.draw(u)),this.global_callbacks.set("finish-dialog",(()=>{if(l||void 0!==u&&u.finished){this.renderer.draw(new A(h.background,new e(0,0,this.width,this.height))),this.renderer.draw(new A(this.play_bar,new e(.125*this.width,.015*this.height,.75*this.width,.125*this.height))),this.renderer.draw(new M(new e(.125*this.width,.15*this.height,.75*this.width,.7*this.height))),this.renderer.draw(new s(`关卡${Math.floor(i)+1}（共${h.levels.length}关）: ${Math.floor(r)+1} / ${o.scenes.length}`,new e(.625*this.width,.015*this.height,.25*this.width,.125*this.height),"#000000",.03*this.height));let c=new k("查看问题",new e(.14*this.width,.045*this.height,.195*this.height,.065*this.height),.03*this.height,null,"rgba(0, 0, 0, 0)","#000000");c.onclick=()=>{this.alert(a.question)},this.renderer.draw(c);for(let t of d)this.renderer.draw(t);let u=.1*this.height,g=u*(this.button_background.width/this.button_background.height),_=new k("",new e(this.width/2-g/2,.875*this.height,g,u),16,this.button_background);_.onclick=()=>{if(a.correct_func(d)){let e;++r>=o.scenes.length&&(r=0,++i>=h.levels.length&&(i=0,t++)),e=0==i&&0==r?"已完成本章全部关卡！":0==r?"恭喜你，成功完成本关卡！<br>快去下一关看看吧！":"太棒了！操作正确！<br>请接着做后面的实验吧！",this.alert(e,(()=>{let e,s;l?(e=n,s=new Promise((t=>{t(1)}))):(e={session:t,level:i,scene:r},s=this.update_progress(e)),s.then((e=>{0!=e&&0==i&&0==r?this.pick_session():0==r?this.pick_level(t):this.play_scene(t,i,r)}))}))}else if(l)this.alert("太遗憾了，你的操作是错误的！<br>请再试试吧！",(()=>{this.play_scene(t,i,r)}));else{let e={session:t,level:i,scene:Math.floor(r)+.5};this.update_progress(e).then((()=>{this.alert("太遗憾了，你的操作是错误的！<br>回到文献中再看看吧！",(()=>{this.read_paper(t,i,20)}))}))}},this.renderer.draw(_),this.renderer.removeEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.render()}})),this.renderer.addEventListener("click",this.global_callbacks.get("finish-dialog")),this.renderer.render(!0)}alert(t,e=null,i=!0){if(!this.is_alert){this.is_alert=!0,this.alert_modal.querySelector(".cg-game-alert-text").innerHTML=`<p>${t}</p>`,this.alert_modal.style.display="flex",i&&this.alert_modal.classList.add("cg-game-alert-blur");let r=()=>{this.alert_modal.querySelector(".cg-game-alert-confirm").removeEventListener("click",r),this.alert_modal.style.display="none",this.is_alert=!1,this.alert_modal.classList.remove("cg-game-alert-blur"),null!=e&&e()};this.alert_modal.querySelector(".cg-game-alert-confirm").addEventListener("click",r)}}menu(){if(this.is_alert||this.is_showing_menu)this.is_showing_menu&&(this.renderer.parent.querySelector(".menu-modal").remove(),this.is_showing_menu=!1);else{this.is_showing_menu=!0;let t=document.createElement("div");if(t.className="menu-modal",this.renderer.parent.appendChild(t),!this.is_picking_session){let e=document.createElement("div");e.className="menu-option",e.innerText="返回主界面",t.appendChild(e);let i=()=>{e.removeEventListener("click",i),t.remove(),this.is_showing_menu=!1,this.pick_session()};e.addEventListener("click",i)}let e=document.createElement("div");e.className="menu-option",e.innerText="关闭菜单",t.appendChild(e);let i=()=>{e.removeEventListener("click",i),t.remove(),this.is_showing_menu=!1};e.addEventListener("click",i);let r=document.createElement("div");r.className="menu-option",r.innerText="关于游戏",t.appendChild(r);let s=()=>{r.removeEventListener("click",s),t.remove(),this.is_showing_menu=!1,this.about()};r.addEventListener("click",s);let n=document.createElement("div");n.className="menu-option",n.innerText="退出登录",t.appendChild(n);let h=()=>{n.removeEventListener("click",h),t.remove(),this.is_showing_menu=!1,this.logout()};n.addEventListener("click",h)}}about(){this.is_alert=!0;let t=document.createElement("div");t.className="about-modal",this.renderer.parent.appendChild(t);let e=document.createElement("div");e.id="about-content",t.appendChild(e),e.innerHTML=this.about_text;let i=document.createElement("div");i.id="about-close",i.innerText="关闭",e.appendChild(i),i.addEventListener("click",(()=>{t.remove(),this.is_alert=!1}))}logout(){window.open("/logout","_self")}load(){return U(this,void 0,void 0,(function*(){this.button_background=yield b(H),this.object_select_grid=yield b(F),this.object_select_background=yield b(O),this.speaker=yield b(B),this.play_bar=yield b(D)}))}start(){return U(this,void 0,void 0,(function*(){yield this.load();let t=document.createElement("div");t.className="cg-game-alert",t.style.display="none",this.renderer.parent.appendChild(t);let e=document.createElement("div");e.className="cg-game-alert-window",t.appendChild(e);let i=document.createElement("img");i.className="cg-game-alert-background",i.src=W,e.appendChild(i);let r=document.createElement("div");r.className="cg-game-alert-text",e.appendChild(r);let s=document.createElement("img");s.className="cg-game-alert-confirm",s.src=H,e.appendChild(s),this.alert_modal=t,this.pick_session()}))}destroy(){window.removeEventListener("resize",this.resize_callback),document.removeEventListener("keyup",this.keyup_callback)}}J=X,X.event_listeners=new Map,X.event_list=[],X.event_processor=window.setInterval((()=>{for(let t of J.event_list)J.event_listeners.has(t.event)&&J.event_listeners.get(t.event)(t.param);J.event_list=[]}),0);!function(){var t,i,r,s;t=this,i=void 0,s=function*(){if(new x,void 0!==window.image_list)for(let t of window.image_list)yield b(t);let t=yield b(window.game_map),i=yield b(window.finished_marker),r=yield b(window.unfinished_marker),s=[];for(let t of window.sessions)s.push({position:new e(...t.position),get:t.get});window.sessions=[];let n=new X({map:t,finished_marker:i,unfinished_marker:r,sessions:s});n.about_text=window.about_text,yield n.start()},new((r=void 0)||(r=Promise))((function(e,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function o(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(t){t(i)}))).then(h,o)}a((s=s.apply(t,i||[])).next())}))}()})()})();